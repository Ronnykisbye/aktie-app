<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Aktie-App v8.2 â€“ Udvikling i DKK & %</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
  <h1>ğŸ“ˆ Aktie-App v8.2 â€“ Udvikling i DKK & %</h1>
  <p>Tryk pÃ¥ <b>IndlÃ¦s og beregn</b> for at hente dine fonde.</p>

  <label for="csvFile">VÃ¦lg din CSV-fil med fondskurser:</label><br>
  <input type="file" id="csvFile" accept=".csv"><br><br>

  <button id="loadBtn">ğŸ“Š IndlÃ¦s og beregn</button>
  <button id="pdfBtn" style="display:none;">ğŸ’¾ Download som PDF</button>

  <div id="loader" style="display:none; margin-top:20px;">
    <p>â³ Henter dataâ€¦ Vent venligst</p>
  </div>

  <div id="output"></div>

  <script>
    // Funktion til at hente valutakursen EUR/DKK
    async function hentValutakurs() {
      try {
        const response = await fetch("https://query1.finance.yahoo.com/v8/finance/chart/EURDKK=X?interval=1d&range=1d");
        const data = await response.json();
        const kurs = data.chart.result[0].meta.regularMarketPrice;
        return kurs;
      } catch (error) {
        alert("Kunne ikke hente valutakurs (EUR/DKK). Bruger 7.45 som standard.");
        return 7.45;
      }
    }

    // Beregner og viser resultater
    function beregnData(data) {
      let samletDKK = 0;
      hentValutakurs().then(kursEURDKK => {
        let html = `
          <div id="rapport">
          <table>
            <tr>
              <th>Navn</th><th>Kurs (EUR)</th><th>Kurs (DKK)</th>
              <th>Antal</th><th>KÃ¸bsKurs (EUR)</th>
              <th>Udvikling (%)</th><th>Udvikling (DKK)</th>
            </tr>`;
        data.forEach(rad => {
          if (!rad.Navn) return;
          const kursDKK = rad.KursEUR * kursEURDKK;
          const udviklingProcent = ((rad.KursEUR - rad.KÃ¸bsKursEUR) / rad.KÃ¸bsKursEUR * 100).toFixed(2);
          const udviklingDKK = ((rad.KursEUR - rad.KÃ¸bsKursEUR) * rad.Antal * kursEURDKK).toFixed(2);
          const farve = udviklingDKK >= 0 ? "lime" : "red";
          const pil = udviklingDKK >= 0 ? "ğŸ”¼" : "ğŸ”½";
          samletDKK += rad.KursEUR * rad.Antal * kursEURDKK;
          html += `
            <tr>
              <td>${rad.Navn}</td>
              <td>${rad.KursEUR.toFixed(2)}</td>
              <td>${kursDKK.toFixed(2)}</td>
              <td>${rad.Antal}</td>
              <td>${rad.KÃ¸bsKursEUR.toFixed(2)}</td>
              <td style="color:${farve}">${pil} ${udviklingProcent}%</td>
              <td style="color:${farve}">${pil} ${udviklingDKK} DKK</td>
            </tr>`;
        });
        html += `</table>
          <h3>ğŸ’° Samlet portefÃ¸ljevÃ¦rdi: ${samletDKK.toFixed(2)} DKK</h3>
          </div>`;
        document.getElementById("output").innerHTML = html;
        document.getElementById("loader").style.display = "none";
        document.getElementById("pdfBtn").style.display = "inline-block";
      });
    }

    // Klik pÃ¥ knappen "IndlÃ¦s og beregn"
    document.getElementById("loadBtn").addEventListener("click", () => {
      document.getElementById("loader").style.display = "block";
      document.getElementById("output").innerHTML = "";
      document.getElementById("pdfBtn").style.display = "none";

      let fil = document.getElementById("csvFile").files[0];
      if (!fil) {
        const csvUrl = "https://raw.githubusercontent.com/Ronnykisbye/aktie-app/main/fonde.csv";
        fetch(csvUrl)
          .then(response => response.text())
          .then(text => {
            Papa.parse(text, {
              header: true,
              dynamicTyping: true,
              complete: function(resultat) {
                beregnData(resultat.data);
              }
            });
          })
          .catch(err => alert("Kunne ikke hente fonde.csv: " + err));
        return;
      }

      Papa.parse(fil, {
        header: true,
        dynamicTyping: true,
        complete: function(resultat) {
          beregnData(resultat.data);
        }
      });
    });

    // Download som PDF
    document.getElementById("pdfBtn").addEventListener("click", () => {
      const element = document.getElementById("rapport");
      const options = {
        margin: 10,
        filename: 'aktie-rapport.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(options).from(element).save();
    });
  </script>
</body>
</html>
