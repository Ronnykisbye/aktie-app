<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“Š Aktie-App v8.3 â€“ Udvikling i DKK & %</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
  <header>
    <h1>ðŸ“ˆ Udvikling siden 10/09/2025 (DKK & %)</h1>
    <p class="hint">Tryk pÃ¥ <b>Opdater</b> for at hente dine fonde og valutakurs.</p>
    <div class="actions">
      <button id="reloadBtn">ðŸ”„ Opdater</button>
      <button id="pdfBtn" class="ghost" title="Gem rapport som PDF">ðŸ’¾ Download som PDF</button>
    </div>
    <div id="loader" class="loader" style="display:none">
      <span class="spinner"></span> Henter dataâ€¦ vent venligst
    </div>
  </header>

  <main id="output"></main>

  <script>
    // --- Indstillinger ---
    const CSV_URL = "https://raw.githubusercontent.com/Ronnykisbye/aktie-app/main/fonde.csv";
    const ECB_URL = "https://api.exchangerate.host/latest?base=EUR&symbols=DKK";

    // SVG ikoner (inline) â€“ lette, skalerbare og farves via 'fill'
    const SVG_UP = `
      <svg class="arrow" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 4l7 8h-4v8H9v-8H5z"></path>
      </svg>`;
    const SVG_DOWN = `
      <svg class="arrow" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 20l-7-8h4V4h6v8h4z"></path>
      </svg>`;
    const SVG_EQUAL = `
      <svg class="arrow" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="5" y="10" width="14" height="4" rx="2" ry="2"></rect>
      </svg>`;

    async function hentEURDKK() {
      try {
        const res = await fetch(ECB_URL, { cache: "no-store" });
        const data = await res.json();
        if (!data || !data.rates || !data.rates.DKK) throw new Error("manglende DKK");
        return data.rates.DKK;
      } catch (e) {
        alert("Kunne ikke hente EUR/DKK fra ECB. Bruger 7.45 som standard.");
        return 7.45;
      }
    }

    function formatDKK(v) {
      return Number(v).toLocaleString("da-DK", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function formatEUR(v) {
      return Number(v).toLocaleString("da-DK", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function pilSVG(kursEUR, kobEUR) {
      if (kursEUR > kobEUR) return { svg: SVG_UP, cls: "up", title: "Over kÃ¸bspris" };
      if (kursEUR < kobEUR) return { svg: SVG_DOWN, cls: "down", title: "Under kÃ¸bspris" };
      return { svg: SVG_EQUAL, cls: "equal", title: "UÃ¦ndret vs. kÃ¸bspris" };
    }

    function render(data, eurDkk) {
      let samletDKK = 0;

      let html = `
        <section id="rapport">
          <table class="card">
            <thead>
              <tr>
                <th>Navn</th>
                <th>Kurs (EUR)</th>
                <th>Kurs (DKK)</th>
                <th>Antal</th>
                <th>KÃ¸bsKurs (EUR)</th>
                <th>Udvikling (%)</th>
                <th>Udvikling (DKK)</th>
              </tr>
            </thead>
            <tbody>
      `;

      data.forEach(row => {
        if (!row || !row.Navn) return;

        const kursEUR = Number(row.KursEUR);
        const kobEUR  = Number(row.KÃ¸bsKursEUR);
        const antal   = Number(row.Antal);

        const kursDKK = kursEUR * eurDkk;
        const udvikPct = ((kursEUR - kobEUR) / kobEUR) * 100;
        const udvikDKK = (kursEUR - kobEUR) * antal * eurDkk;

        samletDKK += kursEUR * antal * eurDkk;

        const arrow = pilSVG(kursEUR, kobEUR);
        const pctClass = udvikDKK >= 0 ? "pos" : (udvikDKK < 0 ? "neg" : "neu");

        html += `
          <tr>
            <td class="left">${row.Navn}</td>
            <td class="kurs">
              <span class="kurs-val">${formatEUR(kursEUR)}</span>
              <span class="arrow-wrap ${arrow.cls}" title="${arrow.title}">${arrow.svg}</span>
            </td>
            <td>${formatDKK(kursDKK)}</td>
            <td>${antal}</td>
            <td>${formatEUR(kobEUR)}</td>
            <td class="${pctClass}">${udvikPct.toFixed(2)}%</td>
            <td class="${pctClass}">${formatDKK(udvikDKK)} DKK</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
          <h3 class="total">ðŸ’° Samlet portefÃ¸ljevÃ¦rdi: ${formatDKK(samletDKK)} DKK</h3>
        </section>
      `;

      document.getElementById("output").innerHTML = html;
      document.getElementById("pdfBtn").classList.remove("ghost");
    }

    async function kÃ¸r() {
      const loader = document.getElementById("loader");
      const out = document.getElementById("output");
      document.getElementById("pdfBtn").classList.add("ghost");
      loader.style.display = "inline-flex";
      out.innerHTML = "";

      try {
        const [eurDkk, csvText] = await Promise.all([
          hentEURDKK(),
          fetch(CSV_URL, { cache: "no-store" }).then(r => r.text())
        ]);

        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (res) => {
            render(res.data, eurDkk);
            loader.style.display = "none";
          },
          error: () => {
            loader.style.display = "none";
            alert("Kunne ikke lÃ¦se fonde.csv");
          }
        });
      } catch (e) {
        loader.style.display = "none";
        alert("Fejl under hentning: " + e.message);
      }
    }

    // Event handlers
    document.getElementById("reloadBtn").addEventListener("click", kÃ¸r);
    document.getElementById("pdfBtn").addEventListener("click", () => {
      const el = document.getElementById("rapport");
      html2pdf().set({
        margin: 10,
        filename: "aktie-rapport.pdf",
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      }).from(el).save();
    });

    // Auto-run ved indlÃ¦sning
    window.addEventListener("DOMContentLoaded", kÃ¸r);
  </script>
</body>
</html>
