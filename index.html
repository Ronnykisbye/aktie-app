<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 Aktie-App v10.4 – Med offline funktion</title>

  <!-- PWA-manifest og tema -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00b8ff">

  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    body{background:#0d0d0d;color:#eaeaea;font-family:Segoe UI,Arial,sans-serif;text-align:center;margin:0;padding:20px}
    h1{color:#00b8ff;margin-bottom:8px}
    p{color:#bbb}
    table{width:95%;max-width:1100px;margin:20px auto;border-collapse:collapse;border-radius:10px;overflow:hidden}
    th,td{padding:8px 6px;border-bottom:1px solid #333;text-align:center;font-size:0.95rem}
    th{background:#00b8ff;color:#00111a}
    td{background:#111}
    button{background:#00b8ff;color:#00111a;border:none;padding:10px 18px;margin:10px;border-radius:10px;cursor:pointer;font-weight:700}
    button:hover{background:#0096d6}
    .status{margin-top:6px;color:#aab8c6;font-size:.95rem}
    .pos{color:#38d18e;font-weight:700}
    .neg{color:#ff5a6e;font-weight:700}
    .neu{color:#aab8c6;font-weight:700}
    svg.arrow{width:16px;height:16px;vertical-align:middle;margin-left:4px}
    svg.arrow.up path{fill:#38d18e}
    svg.arrow.down path{fill:#ff5a6e}
    .totals{margin:18px 0 0}
    .totals h3{margin:8px 0}

    /* === Mobilvisning === */
    @media (max-width: 720px) {
      body { padding: 10px; }
      h1 { font-size: 1.05rem; margin: 6px 0; }
      p { font-size: 0.9rem; margin: 4px 0 10px; }

      button {
        width: 100%;
        max-width: 320px;
        margin: 6px auto;
        display: block;
      }

      table { width: 100%; font-size: 0.85rem; }
      th, td { padding: 8px 4px; }

      /* Skjul nogle kolonner på mobil */
      th:nth-child(5), td:nth-child(5) { display: none; } /* Antal */
      th:nth-child(6), td:nth-child(6) { display: none; } /* Kurs (DKK) */
    }
  </style>
</head>

<body>
  <h1>📈 Udvikling siden 10/09/2025 (DKK & %)</h1>
  <p>Tryk på <b>Opdater</b> for at hente dine fonde og valutakurs.</p>

  <button id="updateBtn">🔄 Opdater</button>
  <button id="pdfBtn">📄 Download som PDF</button>

  <div id="status" class="status">Venter på opdatering…</div>
  <div id="output"></div>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/Ronnykisbye/aktie-app/main/fonde.csv";
    const FX_URL  = "https://api.frankfurter.app/latest?from=EUR&to=DKK";
    const FX_CACHE_KEY = "eurdkk_v1";

    // === Valutakurs med cache ===
    async function hentEURDKK() {
      try {
        const cached = JSON.parse(localStorage.getItem(FX_CACHE_KEY) || "null");
        if (cached?.rate) {
          opdaterBaggrund(cached.rate).catch(()=>{});
          return cached.rate;
        }
        const rate = await hentFraNet();
        gemRate(rate);
        return rate;
      } catch {
        return 7.46;
      }
    }

    async function opdaterBaggrund(nu) {
      try {
        const ny = await hentFraNet();
        if (Math.abs(ny - nu) >= 0.0001) {
          gemRate(ny);
          console.log("Ny EUR/DKK:", ny);
        }
      } catch(e){ console.warn("Baggrund FX fejl:", e); }
    }

    async function hentFraNet() {
      const res = await fetch(FX_URL);
      const d = await res.json();
      if (!d?.rates?.DKK) throw new Error("ingen DKK rate");
      return d.rates.DKK;
    }

    function gemRate(rate) {
      localStorage.setItem(FX_CACHE_KEY, JSON.stringify({rate, iso:new Date().toISOString()}));
    }

    const fmtDKK = v => Number(v).toLocaleString("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2});
    const fmtPct = v => (v>0?"+":"") + v.toFixed(2).replace(".",",") + "%";
    const pilSVG = delta => {
      if (delta>0) return '<svg class="arrow up" viewBox="0 0 24 24"><path d="M12 2l6 8h-4v12h-4V10H6z"/></svg>';
      if (delta<0) return '<svg class="arrow down" viewBox="0 0 24 24"><path d="M12 22l-6-8h4V2h4v12h4z"/></svg>';
      return "";
    };

    async function opdater() {
      const status = document.getElementById("status");
      const out = document.getElementById("output");
      status.textContent = "⏳ Henter data…";

      const eurDkk = await hentEURDKK();
      status.textContent = `💶 EUR/DKK = ${eurDkk.toFixed(4)} (opd. ${new Date().toLocaleTimeString("da-DK",{hour:"2-digit",minute:"2-digit"})})`;

      const csvText = await fetch(CSV_URL,{cache:"no-store"}).then(r=>r.text());
      const rows = Papa.parse(csvText,{header:true,dynamicTyping:true,skipEmptyLines:true}).data;

      let totalNowDKK = 0;
      let totalCostDKK = 0;

      let html = `<table>
        <thead>
          <tr>
            <th>Navn</th>
            <th>Udvikling (%)</th>
            <th>Udvikling (DKK)</th>
            <th>Kurs</th>
            <th>Antal</th>
            <th>Kurs (DKK)</th>
          </tr>
        </thead><tbody>`;

      rows.forEach(row => {
        if (!row || !row.Navn) return;
        const navn   = row.Navn.trim();
        const valuta = String(row.Valuta || "").toUpperCase().trim();
        let kurs     = Number(row.Kurs);
        let kob      = Number(row.KøbsKurs);
        const antal  = Number(row.Antal);

        if (navn.toLowerCase().includes("global enhanced")) kob = 195.80;

        const kursDKK = valuta === "EUR" ? kurs * eurDkk : kurs;
        const kobDKK  = valuta === "EUR" ? kob  * eurDkk : kob;

        const valueNow   = kursDKK * antal;
        const valueStart = kobDKK  * antal;
        const deltaDKK   = valueNow - valueStart;
        const deltaPct   = ((kurs - kob) / kob) * 100;

        totalNowDKK  += valueNow;
        totalCostDKK += valueStart;

        const cls = deltaDKK>0 ? "pos" : deltaDKK<0 ? "neg" : "neu";
        html += `<tr>
          <td>${navn}</td>
          <td class="${cls}">${fmtPct(deltaPct)}</td>
          <td class="${cls}">${fmtDKK(deltaDKK)} DKK ${pilSVG(deltaDKK)}</td>
          <td>${kurs.toFixed(2)} ${valuta}</td>
          <td>${antal}</td>
          <td>${fmtDKK(kursDKK)} DKK</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      const totalDeltaDKK = totalNowDKK - totalCostDKK;
      const deltaCls = totalDeltaDKK>0 ? "pos" : totalDeltaDKK<0 ? "neg" : "neu";

      html += `<div class="totals">
        <h3 class="pos">💰 Samlet porteføljeværdi: ${fmtDKK(totalNowDKK)} DKK</h3>
        <h3 class="${deltaCls}">📈 Samlet gevinst/tab siden start: ${fmtDKK(totalDeltaDKK)} DKK</h3>
      </div>`;

      out.innerHTML = html;
      console.log("Sanity-check",{Totalværdi:totalNowDKK,Samletgevinst:totalDeltaDKK});
    }

    document.getElementById("updateBtn").addEventListener("click", opdater);
    document.getElementById("pdfBtn").addEventListener("click", ()=>window.print());
    window.addEventListener("DOMContentLoaded", opdater);

    // === Registrer Service Worker ===
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js")
        .then(() => console.log("✅ Service Worker registreret"))
        .catch(err => console.warn("SW fejl:", err));
    }
  </script>
</body>
</html>
